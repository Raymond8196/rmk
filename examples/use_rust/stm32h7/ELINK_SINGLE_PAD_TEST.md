# ELink 单 Pad 测试指南

## 概述

这个测试套件允许你在**单个 pad** 上测试 ELink 协议，不需要 split 键盘的另一半。

## 测试内容

### 1. 基本编码/解码测试
- 测试 ELink 的基本编码/解码功能
- 验证数据完整性

### 2. 不同大小的消息测试
- 测试 1, 8, 16, 32, 48, 56 字节的消息
- 验证各种消息大小的处理

### 3. 性能测试
- 执行 100 次编码/解码循环
- 测量平均编码/解码时间
- 统计错误率

### 4. 缓冲区管理测试
- 测试流式接收（分块处理）
- 验证缓冲区管理

### 5. SplitMessage 编码/解码测试
- 测试实际的 RMK SplitMessage
- 验证完整的序列化/反序列化流程

## 使用方法

### 1. 启用测试功能

在 `Cargo.toml` 中，确保已启用 `elink` feature：

```toml
[dependencies]
rmk = { path = "../../../rmk", features = ["elink", "defmt"] }
```

### 2. 编译并烧录

```bash
# 编译（启用测试）
cargo build --release --features elink_test

# 烧录到设备
# 使用你的烧录工具（probe-rs, openocd 等）
```

### 3. 运行测试

测试会在设备启动后自动运行（等待 2 秒后开始）。

### 4. 查看测试结果

测试结果会通过 defmt 日志输出，你可以通过以下方式查看：

#### 方法 1: 使用 probe-rs（推荐）

```bash
# 安装工具（如果还没有）
cargo install probe-rs --features cli

# 连接设备并查看日志
probe-rs attach --chip stm32h7b0vb --defmt
```

#### 方法 2: 使用监控脚本（自动统计）

```bash
python3 monitor_elink.py --port /dev/ttyUSB0 --filter elink test
```

#### 方法 3: 使用串口工具

```bash
# Linux
picocom -b 115200 /dev/ttyUSB0

# macOS
screen /dev/cu.usbmodem* 115200
```

**详细说明请参考 `TEST_RESULTS_GUIDE.md`**

## 预期输出

```
========================================
ELink 单 Pad 测试套件
========================================

=== 测试 1: 基本编码/解码 ===
编码成功: 19 字节
✅ 解码成功，数据匹配

=== 测试 2: 不同大小的消息 ===
大小 1 字节: 编码成功，帧大小 12 字节
  ✅ 解码成功
...

=== 测试 3: 性能测试 ===
执行 100 次编码/解码循环...
进度: 10/100
...
=== ELink 测试统计 ===
编码次数: 100
解码次数: 100
平均编码时间: 15 µs
平均解码时间: 20 µs
成功率: 100.0%

=== 测试 4: 缓冲区管理 ===
...

=== 测试 5: SplitMessage 编码/解码 ===
SplitMessage 序列化成功: 5 字节
ELink 编码成功: 总帧大小 17 字节
✅ SplitMessage 解码成功

=== 测试 6: ELink vs Postcard+COBS 对比 ===

消息大小对比:
大小    | ELink帧      | Postcard+COBS | 开销差异
--------+-------------+---------------+----------
6       | 19          | 7             | +12
...

性能对比 (100 次循环):

编码性能:
  ELink:        15 µs/消息
  Postcard+COBS: 8 µs/消息
  ELink 慢:     7 µs (+87.5%)

解码性能:
  ELink:        20 µs/消息
  Postcard+COBS: 10 µs/消息
  ELink 慢:     10 µs (+100.0%)

功能对比:
  ELink:
    ✅ CRC 校验
    ✅ 优先级支持
    ✅ 多设备支持
    ✅ 扩展外设 ID
  Postcard+COBS:
    ❌ 无 CRC 校验
    ❌ 无优先级
    ❌ 无多设备支持
    ✅ 更小的帧开销

========================================
所有测试完成
========================================
```

## 测试完成后

测试完成后，设备会继续正常运行（作为键盘使用）。

## 注意事项

1. **测试时间**: 所有测试大约需要 10-20 秒
2. **内存使用**: 测试会使用一些 RAM，但不会影响正常使用
3. **USB 连接**: 测试期间 USB HID 功能正常，可以继续使用键盘

## 故障排查

### 问题 1: 测试没有运行

- 检查是否启用了 `elink_test` feature
- 检查日志中是否有 "ELink 测试模式已启用"

### 问题 2: 编码/解码失败

- 检查 ELink adapter 初始化是否正确
- 检查消息大小是否超过限制（最大 56 字节）

### 问题 3: 性能测试失败

- 检查是否有足够的 RAM
- 检查是否有其他任务占用 CPU

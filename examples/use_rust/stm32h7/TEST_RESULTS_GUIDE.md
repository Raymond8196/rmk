# PC 端查看测试结果指南

## 测试结果输出方式

测试结果通过 **defmt 日志**输出，你可以通过以下方式在 PC 端查看：

## 方法 1: 使用 probe-rs（推荐）

### 安装工具

```bash
cargo install probe-rs --features cli
```

### 查看测试结果

```bash
# 连接设备并查看日志
probe-rs attach --chip stm32h7b0vb --defmt
```

### 预期输出

你会看到类似以下的测试结果：

```
[INFO] RMK start!
[INFO] ELink 测试模式已启用
[INFO] 等待 2 秒后开始测试...

========================================
ELink 单 Pad 测试套件
========================================

=== 测试 1: 基本编码/解码 ===
[INFO] 编码成功: 19 字节
[INFO] ✅ 解码成功，数据匹配

=== 测试 2: 不同大小的消息 ===
[INFO] 大小 1 字节: 编码成功，帧大小 12 字节
[INFO]   ✅ 解码成功
[INFO] 大小 8 字节: 编码成功，帧大小 19 字节
[INFO]   ✅ 解码成功
[INFO] 大小 16 字节: 编码成功，帧大小 27 字节
[INFO]   ✅ 解码成功
[INFO] 大小 32 字节: 编码成功，帧大小 43 字节
[INFO]   ✅ 解码成功
[INFO] 大小 48 字节: 编码成功，帧大小 59 字节
[INFO]   ✅ 解码成功
[INFO] 大小 56 字节: 编码成功，帧大小 67 字节
[INFO]   ✅ 解码成功

=== 测试 3: 性能测试 ===
[INFO] 执行 100 次编码/解码循环...
[INFO] 进度: 10/100
[INFO] 进度: 20/100
...
[INFO] 进度: 100/100
[INFO] === ELink 测试统计 ===
[INFO] 编码次数: 100
[INFO] 解码次数: 100
[INFO] 编码错误: 0
[INFO] 解码错误: 0
[INFO] CRC 错误: 0
[INFO] 缓冲区溢出: 0
[INFO] 平均编码时间: 15 µs
[INFO] 平均解码时间: 20 µs
[INFO] 成功率: 100.0%

=== 测试 4: 缓冲区管理 ===
[INFO] 开始缓冲区管理测试
[INFO] 消息 1: 编码成功，帧大小 19 字节
[INFO]   消息 1: 解码成功（从偏移 0 开始）
[INFO]   消息 1 处理完成
...

=== 测试 5: SplitMessage 编码/解码 ===
[INFO] SplitMessage 序列化成功: 5 字节
[INFO] ELink 编码成功: 总帧大小 17 字节
[INFO] ✅ SplitMessage 解码成功

=== 测试 6: ELink vs Postcard+COBS 对比 ===

[INFO] 消息大小对比:
[INFO] 大小    | ELink帧      | Postcard+COBS | 开销差异
[INFO] --------+-------------+---------------+----------
[INFO] 6       | 19          | 7             | +12
[INFO] 14      | 27          | 15            | +12
[INFO] 23      | 36          | 24            | +12
[INFO] 35      | 48          | 36            | +12
[INFO] 32      | 45          | 33            | +12

[INFO] 性能对比 (100 次循环):

[INFO] 编码性能:
[INFO]   ELink:        15 µs/消息
[INFO]   Postcard+COBS: 8 µs/消息
[INFO]   ELink 慢:     7 µs (+87.5%)

[INFO] 解码性能:
[INFO]   ELink:        20 µs/消息
[INFO]   Postcard+COBS: 10 µs/消息
[INFO]   ELink 慢:     10 µs (+100.0%)

[INFO] 功能对比:
[INFO]   ELink:
[INFO]     ✅ CRC 校验
[INFO]     ✅ 优先级支持
[INFO]     ✅ 多设备支持
[INFO]     ✅ 扩展外设 ID
[INFO]   Postcard+COBS:
[INFO]     ❌ 无 CRC 校验
[INFO]     ❌ 无优先级
[INFO]     ❌ 无多设备支持
[INFO]     ✅ 更小的帧开销

========================================
所有测试完成
========================================

[INFO] ELink 测试完成，继续正常运行...
```

## 方法 2: 使用监控脚本（自动统计）

### 运行监控脚本

```bash
cd examples/use_rust/stm32h7
python3 monitor_elink.py --port /dev/ttyUSB0 --filter elink test
```

### 脚本输出

脚本会实时显示日志，并每 10 秒统计一次：

```
连接到 /dev/ttyUSB0，波特率 115200
按 Ctrl+C 退出

[10:23:45] === 测试 1: 基本编码/解码 ===
[10:23:45] 编码成功: 19 字节
[10:23:45] ✅ 解码成功，数据匹配
...

============================================================
ELink 统计信息 (运行时间: 10 秒)
============================================================
  总日志行数: 156
  ELink 相关日志: 89
  发送消息: 0
  接收消息: 0

  错误统计:
    总错误数: 0
    缓冲区溢出: 0
    CRC 错误: 0
    无效帧: 0
    解析错误: 0
============================================================
```

## 方法 3: 使用串口工具（原始日志）

### 使用 picocom

```bash
picocom -b 115200 /dev/ttyUSB0
```

### 使用 screen

```bash
screen /dev/ttyUSB0 115200
```

你会看到原始的 defmt 日志输出。

## 测试结果解读

### 1. 基本功能测试结果

- **编码成功**: 消息成功编码为 ELink 帧
- **解码成功**: 帧成功解码回原始消息
- **数据匹配**: 解码后的数据与原始数据一致

### 2. 性能测试结果

- **平均编码时间**: 每条消息的平均编码时间（µs）
- **平均解码时间**: 每条消息的平均解码时间（µs）
- **成功率**: 成功编码/解码的消息百分比

### 3. 协议对比结果

#### 帧大小对比

- **ELink帧**: ELink 协议编码后的帧大小
- **Postcard+COBS**: 原有协议编码后的帧大小
- **开销差异**: ELink 相对于 Postcard+COBS 的额外开销（字节）

#### 性能对比

- **编码性能**: 编码一条消息所需的时间
- **解码性能**: 解码一条消息所需的时间
- **性能差异**: ELink 相对于 Postcard+COBS 的性能差异（µs 和百分比）

#### 功能对比

- **ELink 优势**: CRC 校验、优先级、多设备支持等
- **Postcard+COBS 优势**: 更小的帧开销

## 保存测试结果

### 方法 1: 重定向到文件

```bash
# 使用 probe-rs
probe-rs attach --chip stm32h7b0vb --defmt > test_results.txt

# 使用监控脚本
python3 monitor_elink.py --port /dev/ttyUSB0 > test_results.txt
```

### 方法 2: 使用 tee 同时显示和保存

```bash
probe-rs attach --chip stm32h7b0vb --defmt | tee test_results.txt
```

## 过滤特定测试结果

### 只查看测试结果

```bash
probe-rs attach --chip stm32h7b0vb --defmt | grep -E "(测试|ELink|对比|统计)"
```

### 只查看错误

```bash
probe-rs attach --chip stm32h7b0vb --defmt | grep -i error
```

### 只查看性能数据

```bash
probe-rs attach --chip stm32h7b0vb --defmt | grep -E "(µs|性能|时间)"
```

## 测试结果示例分析

### 正常结果

- ✅ 所有测试通过
- ✅ 成功率 100%
- ✅ 无错误（CRC 错误、缓冲区溢出等为 0）

### 异常结果

- ❌ 成功率 < 100%: 可能有编码/解码错误
- ❌ CRC 错误 > 0: 数据完整性有问题
- ❌ 缓冲区溢出 > 0: 缓冲区可能不够大

## 注意事项

1. **测试时间**: 所有测试大约需要 10-20 秒
2. **日志量**: 测试会产生大量日志，建议使用过滤
3. **实时性**: 日志是实时输出的，可以随时中断（Ctrl+C）

## 故障排查

### 问题 1: 没有看到测试结果

- 检查是否启用了 `elink_test` feature
- 检查设备是否正常连接
- 检查 defmt 是否正确配置

### 问题 2: 日志乱码

- 检查波特率设置（应该是 115200）
- 检查串口设备是否正确

### 问题 3: 测试没有运行

- 检查日志中是否有 "ELink 测试模式已启用"
- 检查是否等待了 2 秒
